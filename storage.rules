rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // 一時アップロード用（認証済みユーザーのみ）
    match /shops/temp/{allPaths=**} {
      allow read, write: if request.auth != null;
    }
    
    match /events/temp/{allPaths=**} {
      allow read, write: if request.auth != null;
    }
    
    // 店舗画像
    match /shops/{shopId}/{allPaths=**} {
      // 全員が読み取り可能
      allow read: if true;
      
      // 認証済みユーザーで、自分の店舗の場合のみ書き込み可能
      allow write: if request.auth != null && 
                   (request.auth.uid == firestore.get(/databases/(default)/documents/shops/$(shopId)).data.ownerUserId ||
                    firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // イベント画像
    match /events/{eventId}/{allPaths=**} {
      // 全員が読み取り可能
      allow read: if true;
      
      // 認証済みユーザーで、自分のイベントの場合のみ書き込み可能
      allow write: if request.auth != null && 
                   (request.auth.uid == firestore.get(/databases/(default)/documents/events/$(eventId)).data.ownerUserId ||
                    firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // マップ（公共施設）画像
    match /maps/{mapId}/{allPaths=**} {
      // 全員が読み取り可能
      allow read: if true;
      
      // 管理者のみ書き込み可能
      allow write: if request.auth != null && 
                   firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}